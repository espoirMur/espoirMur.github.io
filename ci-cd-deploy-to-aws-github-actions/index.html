<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><style data-href="/styles.0194413585df59861852.css">@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-191cc9f50f3b76b9617cb383f19acb7d.woff2) format("woff2"),url(/static/montserrat-latin-100-370318464551d5f25b0f0a78f374faac.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-bdeaeb79db315697bd173a55b097dc18.woff2) format("woff2"),url(/static/montserrat-latin-100italic-ecf7d49386e8f265878e735db34a7c4b.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-85d5ef9db7f2dc6979172a4a3b2c57cb.woff2) format("woff2"),url(/static/montserrat-latin-200-1fc98e126a3d152549240e6244d7e669.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-49095760a498d024fe1a85a078850df9.woff2) format("woff2"),url(/static/montserrat-latin-200italic-fe46cf8b9462c820457d3bf537e4057f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-7c3daf12b706645b5d3710f863a4da04.woff2) format("woff2"),url(/static/montserrat-latin-300-8dc95fab9cf98d02ca8d76e97d3dff60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-f20b178ca2024a5eac8e42e6649db86c.woff2) format("woff2"),url(/static/montserrat-latin-300italic-3fe16939288856e8e828fa2661bf2354.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-bc3aa95dca08f5fee5291e34959c27bc.woff2) format("woff2"),url(/static/montserrat-latin-400-8102c4838f9e3d08dad644290a9cb701.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-5cad650422a7184467af5a4d17b264c4.woff2) format("woff2"),url(/static/montserrat-latin-400italic-d191f22af3bb50902b99ac577f81a322.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-92d16e458625f4d2c8940f6bdca0ff09.woff2) format("woff2"),url(/static/montserrat-latin-500-8b763220218ffc11c57c84ddb80e7b26.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-47bfcca6b69d6a9acca7a8bff17193e2.woff2) format("woff2"),url(/static/montserrat-latin-500italic-72c01f753c3940c0b9cb6bf2389caddf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-6fb1b5623e528e27c18658fecf5ee0ee.woff2) format("woff2"),url(/static/montserrat-latin-600-7c839d15a6f54e7025ba8c0c4b333e8f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-60789af1c9338ed1a9546722ec54b4f7.woff2) format("woff2"),url(/static/montserrat-latin-600italic-f3d4de8d0afb19e777c79032ce828e3d.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-39d93cf678c740f9f6b2b1cfde34bee3.woff2) format("woff2"),url(/static/montserrat-latin-700-80f10bd382f0df1cd650fec59f3c9394.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-ba136d97b14e82284dd595e257f11c47.woff2) format("woff2"),url(/static/montserrat-latin-700italic-8c98142b425630821139c24bd1698700.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-b7018be9ed6cd94da8b6675b3a468c3b.woff2) format("woff2"),url(/static/montserrat-latin-800-9a9befcf50d64f9d2d19d8b1d1984add.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-540ffdd223d1a9ad3d4e678e1a23372e.woff2) format("woff2"),url(/static/montserrat-latin-800italic-897086f99f4e1f45e6b1e9368527d0bc.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-58cd789700850375b834e8b6776002eb.woff2) format("woff2"),url(/static/montserrat-latin-900-26d42c9428780e545a540bbb50c84bce.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-451157bc8861fe54f523b3669a3def71.woff2) format("woff2"),url(/static/montserrat-latin-900italic-a8ec4957e1c24f5793305763ad9845b3.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-b1158cfcd4aacb9d8fb61625e37af46a.woff2) format("woff2"),url(/static/merriweather-latin-300-cc7de05e166e90320d7d896e0f72a19d.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-8fe52a48089d6ebe46db0b8e7cc66263.woff2) format("woff2"),url(/static/merriweather-latin-300italic-e1331f5397c2a673f9d3765138debdb5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-8276fdb72ae8f4714d4e6eba704cc39f.woff2) format("woff2"),url(/static/merriweather-latin-400-69f09800f4f6479d06e44eba837df872.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-3a9be9ea9f7aa4af6de7307df21d9fc0.woff2) format("woff2"),url(/static/merriweather-latin-400italic-d76079ed7541a433a54f79316de086e9.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-fa534be7ffa380e39a7f6e03bf9a5e03.woff2) format("woff2"),url(/static/merriweather-latin-700-ba56ea84b8084b7ff9677f50d3cd81bd.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-1ef5edaaa20ae53ea50399884c5e48c6.woff2) format("woff2"),url(/static/merriweather-latin-700italic-534bc9e7ce93c73d73426e46acd78092.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-7528fb70e8a4a82c7305e72ff43ac25f.woff2) format("woff2"),url(/static/merriweather-latin-900-3799b6e2f5ed3fcccf9d7a708d7419fa.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-e1b4d2aaa78e12ad84aaf8a56321e4c2.woff2) format("woff2"),url(/static/merriweather-latin-900italic-2ae22f731b3424e8dbb4b37f7ca6e708.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#000;text-shadow:0 1px #fff}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}.navigation-links{text-align:right;text-decoration:none}.navigation-links li{color:#eee;display:inline-block;padding:10px 20px;border-radius:20px;-webkit-transition:all .8s;transition:all .8s;text-decoration:none}.navigation-links li.active{text-decoration:underline}.navigation-links li:hover{color:#eee;cursor:pointer;text-decoration:underline}body{background-color:#22264a;background-image:url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEyMCI+PGRlZnM+PHBhdHRlcm4gcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgaWQ9ImMiIHdpZHRoPSI2MCIgaGVpZ2h0PSIxMjAiIHg9IjAiIHk9IjAiIHZpZXdCb3g9IjAgMCA1IDEwIj48cGF0aCBmaWxsLW9wYWNpdHk9IjAiIHN0cm9rZT0iIzI5MjkyOSIgc3Ryb2tlLXdpZHRoPSIwLjA5IiBkPSJNLTIsMUw3LDEwTS0yLDZMNywxNU0tMiwtNEw3LDUiLz48L3BhdHRlcm4+PHBhdHRlcm4gcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgaWQ9ImMyIiB3aWR0aD0iNjAiIGhlaWdodD0iMTIwIiB4PSIxMDAlIiB5PSIwIiB2aWV3Qm94PSIwIDAgNSAxMCI+PHBhdGggZmlsbC1vcGFjaXR5PSIwIiBzdHJva2U9IiMyOTI5MjkiIHN0cm9rZS13aWR0aD0iMC4wOSIgZD0iTTcsMUwtMiwxME03LDZMLTIsMTVNNywtNEwtMiw1Ii8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB3aWR0aD0iNTAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjYykiLz48cmVjdCB4PSI1MCUiIHdpZHRoPSI1MCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNjMikiLz48L3N2Zz4=");margin:0;padding:0;overflow-x:hidden;height:100%;font-family:Lato,Helvetica,arial,sans-serif;font-weight:300;font-size:20px;line-height:1.45;color:#eee;color:hsla(0,0%,100%,.85)}#container{padding-top:50px}#content{max-width:43em;padding:10px;margin:0 auto}.subhead{font-size:1.2em;font-weight:300;line-height:1.5}li,p{font-size:1.7em}a{box-shadow:none;font-weight:700;text-decoration:none;color:#fff}a:hover{text-decoration:underline}p#pleft,p#pright{max-width:20em;float:left}ul{clear:both}html{font-size:62.5%}body{font-size:1em}@media (min-width:600px){html{font-size:80%}}@media (min-width:880px){html{font-size:120%}li,p{font-size:1em}p#pright{margin-left:3em}}.my-details{display:flex;flex-direction:row;flex-wrap:wrap}.my-details img{flex-grow:0;flex-shrink:0;width:150px;height:140px;border-radius:50%;background-repeat:no-repeat;background-position:50%;background-size:cover;margin-left:auto;margin-top:5px;margin-bottom:5px}.my-name{padding-left:5px;font-size:4.8em;font-weight:100;text-transform:uppercase}@media (max-width:768px){.my-details img{margin-left:-245px}.my-name{margin-top:150px;margin-left:20px}}@media (max-width:560px){.my-details img{margin-left:-215px}}@media (max-width:320px){.my-details img{margin-left:-180px}.my-name{font-size:3.5em;margin-top:150px;margin-left:20px}}</style><meta name="generator" content="Gatsby 2.18.12"/><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/icons/icon-48x48.png?v=a5cff9604d0fdc6a2a4b5cbbc637b89f"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a5cff9604d0fdc6a2a4b5cbbc637b89f"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a5cff9604d0fdc6a2a4b5cbbc637b89f"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a5cff9604d0fdc6a2a4b5cbbc637b89f"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a5cff9604d0fdc6a2a4b5cbbc637b89f"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a5cff9604d0fdc6a2a4b5cbbc637b89f"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a5cff9604d0fdc6a2a4b5cbbc637b89f"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a5cff9604d0fdc6a2a4b5cbbc637b89f"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a5cff9604d0fdc6a2a4b5cbbc637b89f"/><title data-react-helmet="true">Deploy a containerized python to AWS using Github Actions | My ideas&#x27; home</title><meta data-react-helmet="true" name="description" content="Tutorial on how to build a ci/cd that use github actions to deploy a python to aws."/><meta data-react-helmet="true" property="og:title" content="Deploy a containerized python to AWS using Github Actions"/><meta data-react-helmet="true" property="og:description" content="Tutorial on how to build a ci/cd that use github actions to deploy a python to aws."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Espoir Murhabazi"/><meta data-react-helmet="true" name="twitter:title" content="Deploy a containerized python to AWS using Github Actions"/><meta data-react-helmet="true" name="twitter:description" content="Tutorial on how to build a ci/cd that use github actions to deploy a python to aws."/><script data-react-helmet="true" type="application/ld+json">{"@context":"https://murhabazi.com","@type":"Personal","url":"https://murhabazi.com","name":"Espoir Murhabazi Website","contactPoint":{"@type":"ContactPoint","telephone":"+250 78 48 3 48 36","contactType":"Personal number"}}</script><link rel="preconnect" href="https://murhabazi.matomo.cloud"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-9d754e30b46c9218f3f0.js"/><link as="script" rel="preload" href="/app-d5c97cf11e79c7a049f0.js"/><link as="script" rel="preload" href="/styles-56e7429501300363e862.js"/><link as="script" rel="preload" href="/commons-e1257f76149fda44e4bb.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-959fbd16f1e490c26892.js"/><link as="fetch" rel="preload" href="/page-data/ci-cd-deploy-to-aws-github-actions/page-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem"><nav class="navigation"><div class="container"><ul class="navigation-links"><li> <a href="/">Home</a> </li><li> <a href="/blog">Blog</a> </li><li><a target="_blank" href="https://drive.google.com/file/d/14yle0nyGH_Kyk7L67nvqwl90FobvY7W0/view?usp=sharing" rel="noopener noreferrer">Resume</a></li></ul></div></nav><header><h3 style="font-family:Montserrat, sans-serif;margin-top:0"><a style="box-shadow:none;text-decoration:none;color:inherit" href="/blog">My ideas&#x27; home</a></h3></header><main><main></main> <article><header><h1 style="margin-top:1.75rem;margin-bottom:0">Deploy a containerized python to AWS using Github Actions<!-- --> </h1> <p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem">26 February, 2021<!-- --> </p> </header> <section><h2>Deploy a containerized python to AWS using Github Actions</h2>
<p>Recently at work we decided to build a CI/CD pipeline to deploy our application directly to AWS . I had never worked with AWS and it was  the missing point on my cv to demonstrate that I have some devops skills . I decided to look for some tutorials online and I was not lucky to have what does what we need at work . I decided to write this guide by getting something working from various tutorials I found  online. </p>
<h3>What you will learn from this tutorial</h3>
<ul>
<li>How to create an AWS architecture where you can deploy an python application</li>
<li>How to use Github Actions to deploy to that architecture</li>
<li>
<p>Some gotcha about deploying on AWS and how I a managed to solve them. </p>
<h3>Who is this tutorial for</h3>
</li>
</ul>
<p>This tutorial is for middle level python developers who are familiar with docker and have a python application with docker-compose. </p>
<h3>Which Application we will deploy</h3>
<p>In this tutorial we will deploy a python application which has a celery worker, a celery scheduler and a redis database for task messaging and task queues. </p>
<p>I am not planning to talk about celery and task queue and how to use those framework but you can get start with them <a href="https://medium.com/analytics-vidhya/python-celery-distributed-task-queue-demystified-for-beginners-to-professionals-part-1-b27030912fea">here</a> and to get started with docker you can use <a href="https://samwalpole.com/getting-started-with-docker">this one</a> and <a href="https://adamtheautomator.com/docker-compose-tutorial/">this one</a> to be familiar with docker compose.</p>
<p>I will not touch to any popular python web framework  such Django, Flask or FastAPi but you can adapt this tutorial to them and I am sure it will work like a charm.</p>
<p>My friends who write Php , Javascrpit or any other fancy language can also leverage this tutorial and adapt something to their language.</p>
<p>The application skeleton can be downloaded from <a href="https://github.com/espoirMur/deploy_python_to_aws_github_actions">this link</a> to get start.</p>
<h3>Getting started</h3>
<p>To get start download a sample project we will be using by running the following command in your cmd, I hope you have git installed in your machine.</p>
<p><code class="language-text">git clone https://github.com/espoirMur/deploy_python_to_aws_github_actions.git</code></p>
<p>As you can see this is just a dummy project which run with run 4 docker containers.</p>
<p>You can follow the readme to get the project running for you.</p>
<h3>Creating the AWS Architecture</h3>
<p>Make sure you have created an AWS account and you have your credentials , the access key and the application secret.</p>
<p>Most of the service used in this tutorial are available with an AWS free tier account. </p>
<p>We will be using this tutorial and follow the steps they gave us to create the architecture we need :</p>
<p>Basically those are the stack we need : </p>
<p>
    <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;">
      <span class="gatsby-resp-image-background-image" style="padding-bottom: 59.44055944055944%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAABYlAAAWJQFJUiTwAAAByUlEQVQoz21Ry27TUBDN1yLxFbCHBXTbDWIDK2DFBgmJUCmtcJPISZS6aRrn+v22Y9/X+MVchxaCah2N5o7vuXPmzIh6Bst8KAJ7szTmV/er6c3skhj6djXd6L9269ndQtuurve3OuZL7QKjyH2e+ywmI54FQjYgIQpjQmzHcXfm3vMD23Edx/Nc3/N8y7LDMEIQYgVBCLKW0ApajljiUMakEACyqUGhqWtQEQEqaQTnqgLQNqomBZNSiiob0diRULetqsu6Q8AQj8AH8BeSEdjgGBUkiCofyBK6rgPJo9txuv2ZKFwkd+PsfsIY7fr+kfwX/5LbrpO8TPSP4eWZ9e2F+/1lMDljxudDkfV9j7cfNKNoVMxPO/c9nqLlF3f86urds+v3z50fr8vN1yyNUfahKGxCHNtGD2lVwVOdq1T/EGnn0eRNNHkba+fU+BT6HqUUjd6bJjHNxWKBfOz//8woKN5puTVLrXlmzXMyxTiMJ4s8x4ZVWeLeLEJC30cTZFWcuF23/R80D0ld47tITOI4S1PUjypu1us8y4EecM8upVx9DK2lnD2CDSWMvCwPmIrhjjJP2TbI5qmnBuDsuI8ncbKk47YH8m98spyuaoA/zwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;"></span>
  <img class="gatsby-resp-image-image" alt="aws objects" title="aws objects" src="/static/164c090d70ce8655152a3cde434bb1f7/799d3/aws_objects.png" srcset="/static/164c090d70ce8655152a3cde434bb1f7/00d96/aws_objects.png 148w,
/static/164c090d70ce8655152a3cde434bb1f7/0b23c/aws_objects.png 295w,
/static/164c090d70ce8655152a3cde434bb1f7/799d3/aws_objects.png 590w,
/static/164c090d70ce8655152a3cde434bb1f7/2a3d6/aws_objects.png 885w,
/static/164c090d70ce8655152a3cde434bb1f7/ae92f/aws_objects.png 1180w,
/static/164c090d70ce8655152a3cde434bb1f7/4ee31/aws_objects.png 1430w" sizes="(max-width: 590px) 100vw, 590px" loading="lazy">
    </span>
</p>
 <p>
    <em><a href="https://chintugudiya.org/focus-areas/tech-work/overview-deploying-glific-on-aws-ecs-fargate-with-cd-in-place/">
    Source</a></em>
</p>
<p>We will deploy our application using the AWS ECS Fragate launch type which will pull docker images from the Elastic Container Registry aka ECR.</p>
<h4>Why Fragate and not EC2?</h4>
<p>AWS provide us basically two accounts launch type which are the Fragate Launch type and the EC2. </p>
<p>Amazon Elastic Compute Cloud (Amazon EC2) provides scalable computing capacity in the Amazon Web Services (AWS) Cloud. Using Amazon EC2 eliminates your need to invest in hardware up front, so you can develop and deploy applications faster. You can use Amazon EC2 to launch as many or as few virtual servers as you need, configure security and networking, and manage storage. With EC2 you don’t need to care about hardware , everything hardware is managed by AWS. </p>
<p>AWS Fargate is a technology that you can use with Amazon ECS to run <a href="https://aws.amazon.com/what-are-containers">containers</a> without having to manage servers or clusters of Amazon EC2 instances.The  advantages Fragate over EC2 is the fact that you don’t have to configure, provision or scale clusters instance and care about virtual machine.</p>
<p>In a nutshell : </p>
<p>With a virtual machine, someone still has to manage the hardware, but with EC2 that someone is AWS and you never even see the hardware.</p>
<p>With ECS on EC2, someone still has to manage the instances, but with ECS on Fargate that someone is AWS and you never even see the EC2 instances.</p>
<p>ECS has a “launch type” of either EC2 (if you want to manage the instances yourself) or Fargate (if you want AWS to manage the instances). <a href="https://www.reddit.com/r/aws/comments/dvl601/eli5_aws_fargate/f7ddkup?utm_source=share&#x26;utm_medium=web2x&#x26;context=3">Source</a>. </p>
<p>Add cloud watch to check the logs
<a href="https://aws.amazon.com/blogs/containers/create-a-ci-cd-pipeline-for-amazon-ecs-with-github-actions-and-aws-codebuild-tests/">https://aws.amazon.com/blogs/containers/create-a-ci-cd-pipeline-for-amazon-ecs-with-github-actions-and-aws-codebuild-tests/</a></p>
<h3>The objects we need :</h3>
<p>To deploy the application we need the following objects : A cluster, a service , a task definition  with container definition, cloud watch for logging , iam roles.
The bellow picture show how those AWS objects interacts with each other.</p>
<p>Let us define some of those objects and then we will investigate how to create a stack having them using the Python cdk . </p>
<ul>
<li><strong>A cluster</strong>: It is a logical group of container instances that ECS can use for deploying Docker containers. It provides compute power to run application container instances.  In practise a container is usually attached to an AWS Instance. </li>
<li><strong>A service</strong>: It enables us to run and maintain a specified number of instances of a task definition simultaneously in an Amazon ECS cluster. ie. It helps us run single or multiple containers all using the same Task Definition.</li>
<li><strong>The task definition</strong>: A task definition is a specification. You use it to define one or more containers (with image URIs) that you want to run together, along with other details such as environment variables, CPU/memory requirements, etc. The task definition doesn’t actually run anything, its a description of how things will be set up when something does run. The task definition is similar to the docker-compose file. We will later use the docker compose file to generate a task definition. </li>
<li><strong>A task</strong> : A task is an actual thing that is running. ECS uses the task definition to run the task; it downloads the container images, configures the runtime environment based on other details in the task definition. You can run one or many tasks for any given task definition. Each running task is a set of one or more running containers - the containers in a task all run on the same instance.</li>
<li><strong>cloudwatch</strong>: CloudWatch is a monitoring service , we are using it in this stack to get and visualize logs form the docker containers.</li>
</ul>
<p>With all the objects describes we can now move to how to create the object using the python cdk. </p>
<h4>Creating the architecture:</h4>
<p>This picture will be describing what we need to run the application: </p>
<p>
    <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;">
      <span class="gatsby-resp-image-background-image" style="padding-bottom: 70.74829931972789%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACXElEQVQ4y31T227UMBDd//8FXvkC3uEBJF6QSgtF6m6bbC6b+9VJHOd+OPaS0hYJS9Z4JuPjM3Mmh23bsK4rtN2XPht/t8+xFf9bOuewg2n77eYWcZJCDQOUUq/3MGKYF1SxjzyJUVY1yrJCUZTIi4J+hXEc/wIuy4LvP+5R1cKAa3/We56x0J+kMHnRzSecPn/Aoxvg4XiE6/kkkSCKYnRd9xrwbcmG+TKbWPrxHcov7yG6Ht7dV/ghQeKEIBITmQVhhLZtXwPq0l6C7XtZVpxtG47jIGOJke8hD1xYlg0/CNEQ6Oy4/wLq8vRa//R0L31d+dg0Q04LGlHD5mXfsY11XA8ut2U7kLLH4aW6+oPDJN3smr2shYBoGgjRoGDMuiRwoxRJVpi4PrtRhigrzR2lhivDln3o6QRhgDRP0A89BZmprILsOwzjQGFmFFTSC2PUZDIy9nB6hOP7KOlL1WNg/mHgONhnB3leQI0EnhqWJw1j1fewzi4qPRLTZGJa+X7SrdkwMbaxHXKcMc4TSfUacMD9/S80akRNBYeJjNWMh0uFslU4hQJR2cGKBbysRVz15pzWEsdAoOoGk6PVV6zs0HJ2LkFEBjM6KcmAM0dxzn6ISrQI4hR5KVCyp14Qs3ctLM5gxb7atLpd7iViTnUt+aoiFdWlKGlK0bHTk8VHRvbpycxbmuV44phIPnpkTNvbu59oKE7Gb0VZmp4fngfYiNOiowid7PjHVMYWVUk2NRWv+YvlJtbKFk3XUO2UjIUpVfsGcJ+3HVSz21k/s3+Rc/2+mv32zrZu+A2qPjMTo/STDQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;"></span>
  <img class="gatsby-resp-image-image" alt="aws architecture" title="aws architecture" src="/static/416046a7ad233f3cdd57171f273a55c2/799d3/aws_architecture.png" srcset="/static/416046a7ad233f3cdd57171f273a55c2/00d96/aws_architecture.png 148w,
/static/416046a7ad233f3cdd57171f273a55c2/0b23c/aws_architecture.png 295w,
/static/416046a7ad233f3cdd57171f273a55c2/799d3/aws_architecture.png 590w,
/static/416046a7ad233f3cdd57171f273a55c2/2a3d6/aws_architecture.png 885w,
/static/416046a7ad233f3cdd57171f273a55c2/ae92f/aws_architecture.png 1180w,
/static/416046a7ad233f3cdd57171f273a55c2/400d5/aws_architecture.png 1764w" sizes="(max-width: 590px) 100vw, 590px" loading="lazy">
    </span>
</p>
 <p>
    <em>Our architecture and workflow in  a nutshell <em>
</em></em></p>
<p>To build the infrastructure, we will be leverage the <a href="https://aws.amazon.com/cdk/">AWS Cloud Development Kit (CDK)</a>. If you are new to the CDK, see <a href="https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html">Getting Started with the AWS CDK</a>, it is  a simple and straigthforward to install. In this post, we will be using the CDK with Python 3.7.
Another alternative to the cdk is to create the application via the aws console, however I found the cdk to be simplest approach because , I am a programmer and with the code we can have a full control on what we are creating .</p>
<p>After installing the cdk check if it working with the following command: </p>
<ul>
<li><code class="language-text">cdk --version</code> it should put the your cdk version.</li>
</ul>
<h5>Initializing the AWS  CLI :</h5>
<p>Make sure you have the aws cli installed in your computer. . <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html">Configure your AWS CLI</a> with an IAM user that has permissions to create the resources (VPC, ECS, ECR, IAM Role) described in the template below.
After the configuration you should have the aws keys stored in your computer at the following location : </p>
<ul>
<li><code class="language-text">~/.aws/credentials</code> : if you are using a mac or linux</li>
<li><code class="language-text">C:\Users\`USERNAME`\.aws\config</code>: if you are on Windows </li>
</ul>
<p>The content of that file should look like this one: </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">[default]
region=your region
aws_access_key_id = *********************************
aws_secret_access_key = ******************************</code></pre></div>
<p>We the crendentials , the cli and the cdk installed let us move to the second step about creating the archictecture. </p>
<h4>Initializing The cdk Project :</h4>
<p>To initialize the cdk we will create another project wich will contains the code to create the architecture.</p>
<p><em><em>Step 1</em></em> : Creating the project </p>
<p>Run the following command to creat a new cdk project :
<code class="language-text">mkdir ecs-devops-cdk</code></p>
<p>Enter the project using :
<code class="language-text">cd ecs-devops-cdk</code></p>
<p>Or if you are using Vscode you can open the project with vs code using :
<code class="language-text">code ecs-devops-cdk</code></p>
<ul>
<li><em>Step 2</em>:  Initialize the python cdk project : </li>
</ul>
<p>To initialize the cdk project run the following command :
<code class="language-text">cdk init --language python</code></p>
<p>The command will create a new python cdk project and we will be editing it in the next step to build our stack. </p>
<p>After a quick look you should see a structure like this in your project: </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">.
├── README.md
├── app.py
├── cdk.json
├── ecs_devops_cdk
│   ├── __init__.py
│   └── ecs_devops_cdk_stack.py
├── requirements.txt
├── setup.py
└── source.bat</code></pre></div>
<ul>
<li><strong>Step 3</strong> : activate virtual enviroment : </li>
</ul>
<p>You can activate your virtuall environment using the following code : </p>
<p>On mac and linux : <code class="language-text">source .env/bin/activate</code>
For windows : <code class="language-text">.env\Scripts\activate.bat</code></p>
<ul>
<li><strong>step 4</strong> : Installing dependencies:
With the virtual environment created we can now install the dependencies : </li>
</ul>
<p><code class="language-text">pip install -r requirements.txt</code>
and
<code class="language-text">pip install aws_cdk.aws_ec2 aws_cdk.aws_ecs aws_cdk.aws_ecr aws_cdk.aws_iam</code></p>
<p>With the project initialized we can now move to the next step where we will be creating our components. </p>
<h4>Creating the objects :</h4>
<p>We can now move to the stack creation step </p>
<p>If you open the file under <code class="language-text">ecs_devops_cdk/ecs_devops_cdk_stack.py</code>  you should be able to see the followings : </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">from aws_cdk import core
class  EcsDevopsCdkStack(core.Stack):

  

def  __init__(self, scope: core.Construct, construct_id:  str,  **kwargs)  -&gt;  None:

super().__init__(scope, construct_id,  **kwargs)</code></pre></div>
<p>it is basically a class that will contains the code defining our stack. </p>
<h5>Import the core functionality :</h5>
<p>Edit the first line to import the code we need to create the following stack: </p>
<p><code class="language-text">from aws_cdk import  (core, aws_ecs as ecs, aws_ecr as ecr, aws_ec2 as ec2, aws_iam as iam, aws_logs)</code></p>
<h5>Create the container repository</h5>
<p>To create a container repository you can use the following command : </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">ecr_repository = ecr.Repository(self,  &quot;ecs-devops-repository&quot;, repository_name=&quot;ecs-devops-repository&quot;)</code></pre></div>
<h5>Creating the VPC</h5>
<p>We can either create a vpc or use an existing vpc .
To create a vpc use can add the following code the  <code class="language-text">__init__</code> method. </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">vpc = ec2.Vpc(self,  &quot;ecs-devops-vpc&quot;, max_azs=3)</code></pre></div>
<p>You can also use an existing vpc , if that is the case for you use the following lines: </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">vpc = ec2.Vpc.from_lookup(self, &quot;ecs-devops-vpc&quot;,vpc_id=&#39;vpc-number&#39;)</code></pre></div>
<p>For this you need the vpc name and the corresponding id. </p>
<h5>Cluster Creation :</h5>
<p>With the vpc created we can attached the cluster to it .
To create the cluster we can use the following code : </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">cluster = ecs.Cluster(self,  
					  &quot;ecs-devops-cluster&quot;, 
					  cluster_name=&quot;ecs-devops-cluster&quot;,
					  vpc=vpc)</code></pre></div>
<h5>Creating the Role:</h5>
<p>Let us create the role , the role will give the service the permission to do some tasks . </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">execution_role = iam.Role(self,  &quot;ecs-devops-execution-role&quot;, assumed_by=iam.ServicePrincipal(&quot;ecs-tasks.amazonaws.com&quot;), role_name=&quot;ecs-devops-execution-role&quot;)</code></pre></div>
<p>With the execution role created we can it to policy to give it the permission it needs (This sentence needs to be refractored)</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">execution_role.add_to_policy(iam.PolicyStatement( effect=iam.Effect.ALLOW, resources=[&quot;*&quot;], actions=[  &quot;ecr:GetAuthorizationToken&quot;,  &quot;ecr:BatchCheckLayerAvailability&quot;,  &quot;ecr:GetDownloadUrlForLayer&quot;,  &quot;ecr:BatchGetImage&quot;,  &quot;logs:CreateLogStream&quot;,  &quot;logs:PutLogEvents&quot;  ]  ))</code></pre></div>
<p>With the iam role create we can attach to it a task definition</p>
<h5>Creating the task definition :</h5>
<p>Here is the code we used to create the task definition ; </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">task_definition = ecs.FargateTaskDefinition(self,  &quot;ecs-devops-task-definition&quot;, execution_role=execution_role, family=&quot;ecs-devops-task-definition&quot;)</code></pre></div>
<p>And  the container : </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">container = task_definition.add_container(&quot;ecs-devops-sandbox&quot;, image=ecs.ContainerImage.from_registry(&quot;amazon/amazon-ecs-sample&quot;)  )</code></pre></div>
<p>In the code above, we are initially specifying the Task Definition to run with an example container from a public AWS sample registry. This sample container is replaced with our application container when our CI/CD pipeline updates the Task Definition. We are using the container from the sample registry to allow the Service to stabilize before any application container images are added to our ECR repository.</p>
<p>With the task definition created we can attach a service that will be running it  . </p>
<h5>Creating the service :</h5>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">service = ecs.FargateService(self,  &quot;ecs-devops-service&quot;, cluster=cluster, task_definition=task_definition, service_name=&quot;ecs-devops-service&quot;)</code></pre></div>
<p>The service use the task definition and you can see it is attached to our created cluster. </p>
<h5>Creating the cloudwatch service :</h5>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">log_group = aws_logs.LogGroup(

self,

&quot;ecs-devops-service-logs-groups&quot;,

log_group_name=&quot;ecs-devops-service-logs&quot;)</code></pre></div>
<p>As stated before we will be transferring the docker logs to our log group created in cloudwatch.</p>
<p>With all the objects created let us make sure that we have all the ingredients for our stack in the following updated file . </p>
<p><code class="language-text">ecs_devops_cdk/ecs_devops_cdk_stack.py</code></p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">from aws_cdk import  (core, aws_ecs as ecs, aws_ecr as ecr, aws_ec2 as ec2, aws_iam as iam, aws_logs)

  
  

class  EcsDevopsCdkStack(core.Stack):

  

def  __init__(self, scope: core.Construct, construct_id:  str,  **kwargs)  -&gt;  None:

super().__init__(scope, construct_id,  **kwargs)

  

# The code that defines your stack goes here

  

ecr_repository = ecr.Repository(self,

&quot;ecs-devops-repository&quot;,

repository_name=&quot;ecs-devops-repository&quot;)

  
  

vpc = ec2.Vpc(self,  &quot;ecs-devops-vpc&quot;,  max_azs=3)

  

cluster = ecs.Cluster(self,

&quot;ecs-devops-cluster&quot;,

cluster_name=&quot;ecs-devops-cluster&quot;,

vpc=vpc)

execution_role = iam.Role(self,

&quot;ecs-devops-execution-role&quot;,

assumed_by=iam.ServicePrincipal(&quot;ecs-tasks.amazonaws.com&quot;),

role_name=&quot;ecs-devops-execution-role&quot;)

  

execution_role.add_to_policy(iam.PolicyStatement(  effect=iam.Effect.ALLOW,

resources=[&quot;*&quot;],

actions=[&quot;ecr:GetAuthorizationToken&quot;,

&quot;ecr:BatchCheckLayerAvailability&quot;,

&quot;ecr:GetDownloadUrlForLayer&quot;,

&quot;ecr:BatchGetImage&quot;,

&quot;logs:CreateLogStream&quot;,

&quot;logs:PutLogEvents&quot;  ]  ))

task_definition = ecs.FargateTaskDefinition(self,

&quot;ecs-devops-task-definition&quot;,

execution_role=execution_role,

family=&quot;ecs-devops-task-definition&quot;)

container = task_definition.add_container(&quot;ecs-devops-sandbox&quot;,

image=ecs.ContainerImage.from_registry(&quot;amazon/amazon-ecs-sample&quot;))

service = ecs.FargateService(self,

&quot;ecs-devops-service&quot;,

cluster=cluster,

task_definition=task_definition,

service_name=&quot;ecs-devops-service&quot;)

log_group = aws_logs.LogGroup(self,

&quot;ecs-devops-service-logs-groups&quot;,

log_group_name=&quot;ecs-devops-service-logs&quot;)</code></pre></div>
<p>Before creating the stack  open the file <code class="language-text">app.py</code> </p>
<p>You should see something like this : </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">from aws_cdk import core

  

from ecs_devops_cdk.ecs_devops_cdk_stack import EcsDevopsCdkStack

  
  

app = core.App()

EcsDevopsCdkStack(app,  &quot;ecs-devops-cdk&quot;)

  

app.synth()</code></pre></div>
<p>Replace the line where your stack is instanciate 4th line with the following : </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">EcsDevopsCdkStack(app,  &quot;ecs-devops-cdk&quot;,  env={

&#39;account&#39;:  &quot;**************&quot;,

&#39;region&#39;:  &quot;your region&quot;

})</code></pre></div>
<p>With this set you can now create your stack
With the code created we can now run the following command to create our stack.</p>
<p><code class="language-text">cdk deploy</code></p>
<p>If everything goes well you should have your stack created . As a results you will have a cluster , running a service that deploys a task definition , and a Cloudwatch log group create . </p>
<p>You can check your stack from the AWS console by navigating to the following <a href="https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks?filteringStatus=active&#x26;filteringText=&#x26;viewNested=true&#x26;hideStacks=false">link</a>.</p>
<p>You should be able to see something like this : </p>
<p>Put the screenshot here</p>
<p>If you want you can check this project on github <a href="https://github.com/espoirMur/ecs-devops-cdk">here</a>
With the task created we can now move back to the project and see how to deploy it .</p>
<h3>Setup Github Actions</h3>
<p>(Should probably talk about what is ci/cd and what are github actions)
In this section we will setup Github Actions  that will automatically deploy the code to the AWS stack we have just created. </p>
<p>The action on every push to the master branch will build  a docker image for our application, login to ECR , push the image to the ECR , update the task definition with the new image pushed url , and start the service with the associated task definition in the AWS Cluster.</p>
<p>(Put an image here)</p>
<p>Here are a list of the github actions we will be using : </p>
<ul>
<li><a href="http://github.com/aws-actions/configure-aws-credentials">Configure-aws-credentials</a> –This will help to  configure AWS credential and region environment variables for use in other GitHub Actions. </li>
<li><a href="http://github.com/aws-actions/amazon-ecr-login">Amazon-ecr-login</a> – This will enable us to log in the local Docker client to one or more Amazon Elastic Container Registry (ECR) registries. After logging we can therefore push our docker images to the registry. </li>
<li><a href="http://github.com/aws-actions/amazon-ecs-render-task-definition">Amazon ECS-render-task-definition</a> – This will help us to render the docker image uri to the task definition.</li>
<li><a href="http://github.com/aws-actions/amazon-ecs-deploy-task-definition">Amazon ECS-deploy-task-definition</a> – This is the action that does the real deploy for us. It will register the AWS task definition to ECS and then deploys it to an Amazon ECS service.</li>
<li><a href="https://github.com/docker/setup-buildx-action">Docker Buildx</a>: This actions will help us to setup the most recent version of docker build , buildx which support caching. It is not mandotory if you don’t need to use caching you can skip it . </li>
</ul>
<h4>Back To the Business : The code we want to deploy .</h4>
<p>Let go back to the project I introduced in the beginning and we will work from it.
From your command line move to the project directory : </p>
<p><code class="language-text">cd deploy_python_to_aws_github_actions</code></p>
<p>Activate your virtual enviroment with : </p>
<p><code class="language-text">source .venv/bin/activate</code></p>
<h4>Creating the task-definition:</h4>
<p>Let recall what is the a task definition it just  a specification. You use it to define one or more containers (with image URIs) that you want to run together, along with other details such as environment variables, CPU/memory requirements, etc.
Since the task definition role is similar to a docker-compose file role , we will therefore use the docker-compose file to generate the task-defintion. We will leverage a python tool called <a href="https://github.com/micahhausler/container-transform">container-transform</a> to accomplish that actions.</p>
<p>You can install it in your project virtual environment with : </p>
<p><code class="language-text">pip install container-transform</code></p>
<p>With the tool installed we can now use to generate the task definition.</p>
<p><code class="language-text">cat docker-compose.yml | container-transform  -v &gt; .aws/task-definition.json</code></p>
<p>The output of this command is send to the file <code class="language-text">.aws/task-definition.json</code> , if everything went well you can have something like this : </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{

&quot;requiresCompatibilities&quot;:  [

&quot;FARGATE&quot;

],

&quot;inferenceAccelerators&quot;:  [],

&quot;containerDefinitions&quot;:  [{

&quot;command&quot;:  [&quot;celery&quot;,  &quot;-A&quot;,  &quot;celery_factory:celery&quot;,  &quot;beat&quot;,  &quot;--scheduler=redbeat.RedBeatScheduler&quot;,  &quot;--loglevel=debug&quot;],

&quot;essential&quot;:  true,

&quot;image&quot;:  &quot;spiny-pi-cards-aws:00000&quot;,

&quot;logConfiguration&quot;:  {

&quot;logDriver&quot;:  &quot;awslogs&quot;,

&quot;options&quot;:  {

&quot;awslogs-group&quot;:  &quot;spiny-pi-cards-logs&quot;,

&quot;awslogs-region&quot;:  &quot;us-east-2&quot;,

&quot;awslogs-stream-prefix&quot;:  &quot;celery-beat&quot;

}

},

&quot;name&quot;:  &quot;celery-beat&quot;,

&quot;stopTimeout&quot;:  120

},

{

&quot;command&quot;:  [&quot;celery&quot;,  &quot;-A&quot;,  &quot;celery_factory:celery&quot;,  &quot;worker&quot;,  &quot;--loglevel=error&quot;,  &quot;-E&quot;],

&quot;essential&quot;:  true,

&quot;image&quot;:  &quot;spiny-pi-cards-aws:00000&quot;,

&quot;logConfiguration&quot;:  {

&quot;logDriver&quot;:  &quot;awslogs&quot;,

&quot;options&quot;:  {

&quot;awslogs-group&quot;:  &quot;spiny-pi-cards-logs&quot;,

&quot;awslogs-region&quot;:  &quot;us-east-2&quot;,

&quot;awslogs-stream-prefix&quot;:  &quot;celery-worker&quot;

}

},

&quot;name&quot;:  &quot;celery-worker&quot;,

&quot;startTimeout&quot;:  10,

&quot;stopTimeout&quot;:  120

},

{

&quot;command&quot;:  [

&quot;celery&quot;,

&quot;-A&quot;,

&quot;celery_factory:celery&quot;,

&quot;flower&quot;,

&quot;--loglevel=error&quot;,

&quot;-E&quot;

],

&quot;environment&quot;:  [

{

&quot;name&quot;:  &quot;FLOWER_PORT&quot;,

&quot;value&quot;:  &quot;5556&quot;

}

],

&quot;essential&quot;:  true,

&quot;image&quot;:  &quot;spiny-pi-cards-aws:00000&quot;,

&quot;logConfiguration&quot;:  {

&quot;logDriver&quot;:  &quot;awslogs&quot;,

&quot;options&quot;:  {

&quot;awslogs-group&quot;:  &quot;spiny-pi-cards-logs&quot;,

&quot;awslogs-region&quot;:  &quot;us-east-2&quot;,

&quot;awslogs-stream-prefix&quot;:  &quot;celery-flower&quot;

}

},

&quot;name&quot;:  &quot;flower&quot;,

&quot;portMappings&quot;:  [

{

&quot;containerPort&quot;:  5556,

&quot;hostPort&quot;:  5556

}

],

&quot;startTimeout&quot;:  30,

&quot;stopTimeout&quot;:  120

},

{

&quot;essential&quot;:  true,

&quot;image&quot;:  &quot;redis&quot;,

&quot;name&quot;:  &quot;redis&quot;,

&quot;logConfiguration&quot;:  {

&quot;logDriver&quot;:  &quot;awslogs&quot;,

&quot;options&quot;:  {

&quot;awslogs-group&quot;:  &quot;spiny-pi-cards-logs&quot;,

&quot;awslogs-region&quot;:  &quot;us-east-2&quot;,

&quot;awslogs-stream-prefix&quot;:  &quot;redis-database&quot;

}

},

&quot;startTimeout&quot;:  5,

&quot;stopTimeout&quot;:  120,

&quot;portMappings&quot;:  [

{

&quot;containerPort&quot;:  6379

}

]

}

],

&quot;volumes&quot;:  [],

&quot;networkMode&quot;:  &quot;awsvpc&quot;,

&quot;memory&quot;:  &quot;6144&quot;,

&quot;cpu&quot;:  &quot;2048&quot;,

&quot;executionRoleArn&quot;:  &quot;arn:aws:iam::969273490168:role/spiny_pi_cards-execution-role&quot;,

&quot;family&quot;:  &quot;spiny_pi_cards-task-definition&quot;,

&quot;taskRoleArn&quot;:  &quot;&quot;,

&quot;placementConstraints&quot;:  []

}</code></pre></div>
<p>What to note here , it all the services we have in the docker-compose file are now in the <code class="language-text">containerDefinitions</code> sections of our task definition.
However that file is not yet full completed we will have to update it with other keys such as the network mode, the resources, the execution role we created before, and the logging option for sending logs to Cloudwatch. Let go now and edit the file by adding the following. And we also need to remove the <code class="language-text">link</code> key from each container definition. </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">&quot;requiresCompatibilities&quot;:  [

&quot;FARGATE&quot;

],

&quot;inferenceAccelerators&quot;:  [],
&quot;volumes&quot;:  [],

&quot;networkMode&quot;:  &quot;awsvpc&quot;,

&quot;memory&quot;:  &quot;512&quot;,

&quot;cpu&quot;:  &quot;256&quot;,

&quot;executionRoleArn&quot;:  &quot;arn:aws:iam::Your-id-from-aws:role/ecs-devops-execution-role&quot;,

&quot;family&quot;:  &quot;ecs-devops-task-definition&quot;,

&quot;taskRoleArn&quot;:  &quot;&quot;,

&quot;placementConstraints&quot;:  []</code></pre></div>
<p>What are those elements ? </p>
<ul>
<li><code class="language-text">requiresCompatibilities</code> : Here we are just specifying that our launch type is of Fragate type . </li>
<li><code class="language-text">networkMode</code> : This is the Docker networking mode to use for the containers in the task. AWS offer the following network modes : <code class="language-text">none</code>, <code class="language-text">bridge</code>, <code class="language-text">awsvpc</code>, and <code class="language-text">host</code>. In Fragate launch type the <code class="language-text">awsvpc</code> network mode is required.  With this setting the task is allocated its own elastic network interface (ENI) and a primary private IPv4 address. This gives the task the same networking properties as Amazon EC2 instances. (Put what I mean by this here) Learn more about the networking mode <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-networking.html">here</a> . </li>
<li><code class="language-text">memory</code>: is the amount of ram to allocate to the containners, if your cluster does not have any registered container instances with the requested memory available, the task will fail.</li>
<li><code class="language-text">cpu</code>: The number of <code class="language-text">cpu</code> units the Amazon ECS container agent will reserve for the container. </li>
<li><code class="language-text">executionRoleArn</code>: The Amazon Resource Name (ARN) of the task execution role that grants the Amazon ECS container agent permission to make AWS API calls on your behalf. As you can see it is the iam role  we created in our cloudformation stack.</li>
<li><code class="language-text">family</code>: is the name of the task definition we created on the cloud formation stack.</li>
</ul>
<p>In each container definition we need to add the code to send the container logs to cloudwatch.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">&quot;logConfiguration&quot;:  {

&quot;logDriver&quot;:  &quot;awslogs&quot;,

&quot;options&quot;:  {

&quot;awslogs-group&quot;:  &quot;ecs-devops-service-logs-groups&quot;,

&quot;awslogs-region&quot;:  &quot;us-east-2&quot;,

&quot;awslogs-stream-prefix&quot;:  &quot;celery-beat&quot;

}

},</code></pre></div>
<p>Add those line to each aws service and just change the <code class="language-text">awslogs-stream-prefix</code> key and put the containner name.
To learn more about task-definitions parameters you can check <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html">the aws documentation</a></p>
<p>With those parameters edited we end up with the following task-definition. </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{

&quot;containerDefinitions&quot;:  [

{

&quot;command&quot;:  [

&quot;celery&quot;,

&quot;-A&quot;,

&quot;celery_factory:celery&quot;,

&quot;beat&quot;,

&quot;--scheduler=redbeat.RedBeatScheduler&quot;,

&quot;--loglevel=debug&quot;

],

&quot;essential&quot;:  true,

&quot;image&quot;:  &quot;task_runner&quot;,

&quot;links&quot;:  [&quot;redis&quot;],

&quot;name&quot;:  &quot;celery-beat&quot;,

&quot;logConfiguration&quot;:  {

&quot;logDriver&quot;:  &quot;awslogs&quot;,

  

&quot;options&quot;:  {

&quot;awslogs-group&quot;:  &quot;ecs-devops-service-logs-groups&quot;,

  

&quot;awslogs-region&quot;:  &quot;us-east-2&quot;,

  

&quot;awslogs-stream-prefix&quot;:  &quot;celery-beat&quot;

}

}

},

{

&quot;command&quot;:  [

&quot;celery&quot;,

&quot;-A&quot;,

&quot;celery_factory:celery&quot;,

&quot;worker&quot;,

&quot;--loglevel=error&quot;,

&quot;-E&quot;

],

&quot;essential&quot;:  true,

&quot;image&quot;:  &quot;task_runner&quot;,

&quot;links&quot;:  [&quot;redis&quot;],

&quot;name&quot;:  &quot;celery-worker&quot;,

&quot;logConfiguration&quot;:  {

&quot;logDriver&quot;:  &quot;awslogs&quot;,

  

&quot;options&quot;:  {

&quot;awslogs-group&quot;:  &quot;ecs-devops-service-logs-groups&quot;,

  

&quot;awslogs-region&quot;:  &quot;us-east-2&quot;,

  

&quot;awslogs-stream-prefix&quot;:  &quot;celery-worker&quot;

}

}

},

{

&quot;command&quot;:  [&quot;./start_flower&quot;],

&quot;environment&quot;:  [

{

&quot;name&quot;:  &quot;FLOWER_PORT&quot;,

&quot;value&quot;:  &quot;5556&quot;

}

],

&quot;essential&quot;:  true,

&quot;image&quot;:  &quot;task_runner&quot;,

&quot;logConfiguration&quot;:  {

&quot;logDriver&quot;:  &quot;awslogs&quot;,

  

&quot;options&quot;:  {

&quot;awslogs-group&quot;:  &quot;ecs-devops-service-logs-groups&quot;,

  

&quot;awslogs-region&quot;:  &quot;us-east-2&quot;,

  

&quot;awslogs-stream-prefix&quot;:  &quot;celery-flower&quot;

}

},

&quot;links&quot;:  [&quot;redis&quot;],

&quot;name&quot;:  &quot;flower&quot;,

&quot;portMappings&quot;:  [

{

&quot;containerPort&quot;:  5556,

&quot;hostPort&quot;:  5556

}

]

},

{

&quot;essential&quot;:  true,

&quot;image&quot;:  &quot;redis&quot;,

&quot;name&quot;:  &quot;redis&quot;,

&quot;containerPort&quot;:  6379,

&quot;logConfiguration&quot;:  {

&quot;logDriver&quot;:  &quot;awslogs&quot;,

&quot;options&quot;:  {

&quot;awslogs-group&quot;:  &quot;ecs-devops-service-logs-groups&quot;,

  

&quot;awslogs-region&quot;:  &quot;us-east-2&quot;,

  

&quot;awslogs-stream-prefix&quot;:  &quot;celery-redis&quot;

}

}

}

],

&quot;requiresCompatibilities&quot;:  [&quot;FARGATE&quot;],

  

&quot;inferenceAccelerators&quot;:  [],

&quot;volumes&quot;:  [],

&quot;networkMode&quot;:  &quot;awsvpc&quot;,

&quot;memory&quot;:  &quot;512&quot;,

&quot;cpu&quot;:  &quot;256&quot;,

&quot;executionRoleArn&quot;:  &quot;arn:aws:iam::Your-id-from-aws:role/ecs-devops-execution-role&quot;,

&quot;family&quot;:  &quot;ecs-devops-task-definition&quot;,

&quot;taskRoleArn&quot;:  &quot;&quot;,

&quot;placementConstraints&quot;:  []

}</code></pre></div>
<p>With the task definition in place , let us move to the Github Actions: </p>
<h4>Creating the Github actions:</h4>
<p>To create Github Actions we can add them from the Github ui or do it from command line.
To peform that operation via commad line you neet to have a folder called <code class="language-text">.github/workflows</code> in your project directory and add your action <code class="language-text">.yml</code> file within it.</p>
<p>Let us create the folder:
<code class="language-text">mkdir .github &amp;&amp; mkdir .github/workflows</code></p>
<p>Then we can create our action file with <code class="language-text">touch .github/workflows/deploy_aws.yml</code></p>
<h5>Setting up</h5>
<p>In the deploy to aws action we add the following code  : </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">on:

push:

branches:

-  master

name:  Deploy to Amazon ECS</code></pre></div>
<p>In this line we are only specifying the event that will trigger our action, this action will be trriggered on a push to master.</p>
<p>Next let us specify the set of job that our actions will run: </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">jobs:

deploy:

name:  Deploy

runs-on:  ubuntu-latest</code></pre></div>
<p>This tell our job to run on ubuntu instance .
The job have the following steps </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">steps:

-  name:  Checkout

uses:  actions/checkout@v1</code></pre></div>
<p>This action checks-out your repository under <code class="language-text">$GITHUB_WORKSPACE</code>, so your workflow can access it.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">-  name:  Set up Python python-version

uses:  actions/setup-python@v1

with:

python-version:  3.7</code></pre></div>
<p>This action setup the python version version to use for our application. </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">-  name:  Set up QEMU

uses:  docker/setup-qemu-action@v1

# https://github.com/docker/setup-buildx-action

-  name:  Set up Docker Buildx

uses:  docker/setup-buildx-action@v1</code></pre></div>
<p>This one setup the docker bulid tools we will be using .</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">-  name:  create docker cache

uses:  actions/cache@v1

with:

path:  ${{ github.workspace }}/cache

key:  ${{ runner.os }}-docker-${{ hashfiles(&#39;cache/**&#39;) }}

restore-keys:  |

${{ runner.os }}-docker-</code></pre></div>
<p>This one create the cache we will be using in the build phase.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">-  name:  generating the config files

run:  |

echo &#39;&#39;&#39;${{ secrets.CONFIGURATION_FILE }}&#39;&#39;&#39; &gt;&gt; .env

echo &quot;done creating the configuration file&quot;</code></pre></div>
<p>This one generate our configuration file, so basically if you have enviroment variables in a .env file, this actions will generate them back. </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">-  name:  Configure AWS credentials

uses:  aws-actions/configure-aws-credentials@v1

with:

aws-access-key-id:  ${{ secrets.AWS_ACCESS_KEY_ID }}

aws-secret-access-key:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}

aws-region:  us-east-2</code></pre></div>
<p>As the name stated this actions will configure your aws crendentials so that you can easily login to the ECR. Don’t forget to add your credentials to your github repository secrets</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">-  name:  Login to Amazon ECR

id:  login-ecr

uses:  aws-actions/amazon-ecr-login@v1</code></pre></div>
<p>As the name stated this use the credentials setup  in the previous steg to login to the container registry.</p>
<p>Once we are login we can now build the container and push to the container registry . </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">-  name:  Build, tag, and push image to Amazon ECR

id:  build-image

env:

ECR_REGISTRY:  ${{ steps.login-ecr.outputs.registry }}

ECR_REPOSITORY:  ecs-devops-repository

IMAGE_TAG:  ${{ github.sha }}

run:  |

docker buildx build -f Dockerfile --cache-from &quot;type=local,src=$GITHUB_WORKSPACE/cache&quot; --cache-to &quot;type=local,dest=$GITHUB_WORKSPACE/cache&quot; --output &quot;type=image, name=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG,push=true&quot; .

echo &quot;::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG&quot;</code></pre></div>
<p>This build the container and push the container registry. Note that the output of this step is the image uri or image name . we will need it in the next step. </p>
<p>The next step we will fill the image name in the each container definition in our task-definition file , so that the docker container will be pulling the new build docker image.</p>
<p>There are 3 setps that are in sequence . The output of one step is used in the next step. </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">-  name:  Fill in the new image ID in the Amazon ECS task definition of the beat container

id:  render-beat-container

uses:  aws-actions/amazon-ecs-render-task-definition@v1

with:

task-definition:  ./.aws/task-definition.json

container-name:  celery-beat

image:  ${{ steps.build-image.outputs.image }}

  

-  name:  Fill in the new image ID in the Amazon ECS task definition of the flower container

id:  render-flower-container

uses:  aws-actions/amazon-ecs-render-task-definition@v1

with:

task-definition:  ${{ steps.render-beat-container.outputs.task-definition }}

container-name:  flower

image:  ${{ steps.build-image.outputs.image }}

  

-  name:  Fill in the new image ID in the Amazon ECS task definition of the worker container

id:  render-worker-container

uses:  aws-actions/amazon-ecs-render-task-definition@v1

with:

task-definition:  ${{ steps.render-flower-container.outputs.task-definition }}

container-name:  celery-worker

image:  ${{ steps.build-image.outputs.image }}</code></pre></div>
<p>With the task definition updated we can now push the task definitions to the service and start running the service. </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">-  name:  Deploy Amazon ECS task definition

uses:  aws-actions/amazon-ecs-deploy-task-definition@v1

with:

task-definition:  ${{ steps.render-worker-container.outputs.task-definition }}

service:  ecs-devops-service

cluster:  ecs-devops-cluster

wait-for-service-stability:  false</code></pre></div>
<p>This is the step that does the actual deployment, it push the task definitions to the service which start the tasks. </p>
<p>(put informtion about logging to the service), explaine the wait-for-service-stability argunment. </p>
<p>Put how to check ifi the application is deployed … </p>
<p>With this added we can make sure we have the following content in our <code class="language-text">.github/workflows/deploy_aws.yml</code> file . </p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">on:

push:

branches:

-  master

name:  Deploy to Amazon ECS

jobs:

deploy:

name:  Deploy

runs-on:  ubuntu-latest

steps:

-  name:  Checkout

uses:  actions/checkout@v1

-  name:  Set up Python python-version

uses:  actions/setup-python@v1

with:

python-version:  3.7

-  name:  Set up QEMU

uses:  docker/setup-qemu-action@v1

# https://github.com/docker/setup-buildx-action

-  name:  Set up Docker Buildx

uses:  docker/setup-buildx-action@v1

-  name:  create docker cache

uses:  actions/cache@v1

with:

path:  ${{ github.workspace }}/cache

key:  ${{ runner.os }}-docker-${{ hashfiles(&#39;cache/**&#39;) }}

restore-keys:  |

${{ runner.os }}-docker-

-  name:  generating the config files

run:  |

echo &#39;&#39;&#39;${{ secrets.CONFIGURATION_FILE }}&#39;&#39;&#39; &gt;&gt; .env

echo &quot;done creating the configuration file&quot;

-  name:  Configure AWS credentials

uses:  ws-actions/configure-aws-credentials@v1

with:

aws-access-key-id:  ${{ secrets.AWS_ACCESS_KEY_ID }}

aws-secret-access-key:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}

aws-region:  us-east-2

-  name:  Login to Amazon ECR

id:  login-ecr

uses:  aws-actions/amazon-ecr-login@v1

  

-  name:  Build, tag, and push image to Amazon ECR

id:  build-image

env:

ECR_REGISTRY:  ${{ steps.login-ecr.outputs.registry }}

ECR_REPOSITORY:  ecs-devops-repository

IMAGE_TAG:  ${{ github.sha }}

run:  |

docker buildx build -f Dockerfile --cache-from &quot;type=local,src=$GITHUB_WORKSPACE/cache&quot; --cache-to &quot;type=local,dest=$GITHUB_WORKSPACE/cache&quot; --output &quot;type=image, name=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG,push=true&quot; .

echo &quot;::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG&quot;

-  name:  Fill in the new image ID in the Amazon ECS task definition of the beat container

id:  render-beat-container

uses:  aws-actions/amazon-ecs-render-task-definition@v1

with:

task-definition:  ./.aws/task-definition.json

container-name:  celery-beat

image:  ${{ steps.build-image.outputs.image }}

-  name:  Fill in the new image ID in the Amazon ECS task definition of the flower container

id:  render-flower-container

uses:  aws-actions/amazon-ecs-render-task-definition@v1

with:

task-definition:  ${{ steps.render-beat-container.outputs.task-definition }}

container-name:  flower

image:  ${{ steps.build-image.outputs.image }}

-  name:  Fill in the new image ID in the Amazon ECS task definition of the worker container

id:  render-worker-container

uses:  aws-actions/amazon-ecs-render-task-definition@v1

with:

task-definition:  ${{ steps.render-flower-container.outputs.task-definition }}

container-name:  celery-worker

image:  ${{ steps.build-image.outputs.image }}

  

-  name:  Deploy Amazon ECS task definition

uses:  aws-actions/amazon-ecs-deploy-task-definition@v1

with:

task-definition:  ${{ steps.render-worker-container.outputs.task-definition }}

service:  ecs-devops-service

cluster:  ecs-devops-cluster

wait-for-service-stability:  false</code></pre></div>
<p>With that , we can now commit the code and see how the application will start the pipeline and get deployed to AWS.
Run the following to deploy.</p>
<p><code class="language-text">git commit -am &#39;setup the ci cd pipeline&#39;</code> </p>
<p><code class="language-text">git push origin master</code></p>
<p>We can check if our github actions are running</p>
<p>(put a screenshot)</p>
<p>If everything goes well you can visualize the deployement here</p>
<p><a href="https://us-east-2.console.aws.amazon.com/ecs/v2/clusters/ecs-devops-cluster/services/ecs-devops-service/deployments?region=us-east-2">https://us-east-2.console.aws.amazon.com/ecs/v2/clusters/ecs-devops-cluster/services/ecs-devops-service/deployments?region=us-east-2</a></p>
<p>Please change your service and cluster with your cluster name and service name in the url. </p>
<p>If everything in your deployment goes well you can check the logs for your worker to see what is happenning there</p>
<p><a href="https://us-east-2.console.aws.amazon.com/cloudwatch/home?region=us-east-2#logsV2:log-groups/log-group/ecs-devops-service-logs">https://us-east-2.console.aws.amazon.com/cloudwatch/home?region=us-east-2#logsV2:log-groups/log-group/ecs-devops-service-logs</a></p></section> <hr style="margin-bottom:1.75rem"/> <footer><div style="display:flex;margin-bottom:4.375rem"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.875rem;margin-bottom:0;min-width:50px;border-radius:100%"><img src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAAAAIEBQMG/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABxpXpmM6j0MArA//EABsQAAICAwEAAAAAAAAAAAAAAAECAxIABBET/9oACAEBAAEFAols8i8GRa3HaC+SJRkPXJPjIBb/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAbEAACAQUAAAAAAAAAAAAAAAAAARECECEiMf/aAAgBAQAGPwJK6lm2CCobOH//xAAaEAEAAgMBAAAAAAAAAAAAAAABACERMUFR/9oACAEBAAE/IQc1DJPYyzWS64x1baP3+M1I0MvS8MQxDip//9oADAMBAAIAAwAAABBAwAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/EB//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/EB//xAAdEAEBAQACAgMAAAAAAAAAAAABEQAhMVFhcYHB/9oACAEBAAE/EOQ9VSywuCGWe/W7ZGKMrieB+8kohxEQrn6ZggdmVaF43mp+GAiu8/M3VZJbZv/Z" alt="Espoir Murhabazi" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms;border-radius:50%"/><noscript><picture><source srcset="/static/3f2f54167cc9ea9c538f94f7a91e5e01/30d3a/profile-pic.jpg 1x,
/static/3f2f54167cc9ea9c538f94f7a91e5e01/66c95/profile-pic.jpg 1.5x,
/static/3f2f54167cc9ea9c538f94f7a91e5e01/aacbd/profile-pic.jpg 2x" /><img loading="lazy" width="50" height="50" srcset="/static/3f2f54167cc9ea9c538f94f7a91e5e01/30d3a/profile-pic.jpg 1x,
/static/3f2f54167cc9ea9c538f94f7a91e5e01/66c95/profile-pic.jpg 1.5x,
/static/3f2f54167cc9ea9c538f94f7a91e5e01/aacbd/profile-pic.jpg 2x" src="/static/3f2f54167cc9ea9c538f94f7a91e5e01/30d3a/profile-pic.jpg" alt="Espoir Murhabazi" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div> <p>Written by <strong> <!-- -->Espoir Murhabazi<!-- --> </strong> , a Engineer from DRC<!-- --> <span class="flag-icon flag-icon-cd"></span> who is currently living and working in Rwanda <span class="flag-icon flag-icon-cd"> . </span></p></div></footer> </article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li> <a rel="prev" href="/ielts-how-it-went/"> <!-- -->←<!-- -->I sat for the IELTS today , here is how it went<!-- --> </a> </li> <li> <!-- --> </li> </ul> </nav> </main><footer>© <!-- -->2021<!-- -->, Build by Espy Mur</footer></div></div></div><script>
    window.dev = undefined
    if (window.dev === true || !(navigator.doNotTrack === '1' || window.doNotTrack === '1')) {
      window._paq = window._paq || [];
      
      
      
      window._paq.push(['setTrackerUrl', 'https://murhabazi.matomo.cloud/piwik.php']);
      window._paq.push(['setSiteId', '1']);
      window._paq.push(['enableHeartBeatTimer']);
      window.start = new Date();

      (function() {
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src='https://murhabazi.matomo.cloud/piwik.js'; s.parentNode.insertBefore(g,s);
      })();

      if (window.dev === true) {
        console.debug('[Matomo] Tracking initialized')
        console.debug('[Matomo] matomoUrl: https://murhabazi.matomo.cloud, siteId: 1')
      }
    }
  </script><noscript><img src="https://murhabazi.matomo.cloud/piwik.php?idsite=1&rec=1&url=https://murhabazi.com/ci-cd-deploy-to-aws-github-actions/" style="border:0" alt="tracker" /></noscript><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/ci-cd-deploy-to-aws-github-actions/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-d5c97cf11e79c7a049f0.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-58be84fb0a4e567a4acb.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-959fbd16f1e490c26892.js"],"component---src-components-blog-index-js":["/component---src-components-blog-index-js-51d08579108aba5ed948.js"],"component---src-pages-404-js":["/component---src-pages-404-js-96cc17a2d9b87624a478.js"],"component---src-pages-index-js":["/component---src-pages-index-js-1113224ae0804a9fa102.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-959fbd16f1e490c26892.js" async=""></script><script src="/commons-e1257f76149fda44e4bb.js" async=""></script><script src="/styles-56e7429501300363e862.js" async=""></script><script src="/app-d5c97cf11e79c7a049f0.js" async=""></script><script src="/webpack-runtime-9d754e30b46c9218f3f0.js" async=""></script></body></html>